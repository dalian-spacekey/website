---
layout: post
title: CentOS7のxl2tpdで困った件
date: 2017-09-02
tags: ["CentOS"]
---

環境的にVPNは欠かせないので、自分でさくらのVPSの一番安いやつで構築してます。CentOS7+xl2tpd+libreswanでL2TPというよくある構成です。
で、"万が一"が想定されるので、備えで常時二系統用意してあります。マスターはVPN専用ですが、バックアップは開発のテスト用サーバーなどに使っています。

が、ちょっとテスト用サーバーをクリーンな状態で再構築する必要があったのでしばらく前にOSからやりなおしたんですが、VPN環境をセットアップしてもVPNが繋がらなくなりました。接続は出来ていて通信が開始されたようなログになってるんですがそのあとすぐ切れてる様子。設定などは動いているものと同じなのでなんか間違ってるというわけではなさそう。

で、いろいろ設定見直したり、インストールしなおしたりしてたんですがだめだったんですが、まあバックアップ系統だったのでしばらく放置していたら、なんかマスターの方の接続が時々だめな状況に陥ることがあったので、バックアップをどうにかしないといけなくなりました。

もう一回全部やり直してマスターの設定と見直すんですが特に問題なく、八方ふさがり状態になったんですが、最後に気がついたのはxl2tpdのバージョンが上がってるということ。

マスターの方は1.3.6、新しくセットアップされていたのは1.3.8。

で、調べてみたら、

[CentOS7のL2TP仕様が若干変わっていた](https://ameblo.jp/j-drucker/entry-12240489746.html)

に、バージョンの違いで動作しなくなる話が出てました。
xl2tpdの設定で、crtsctsとlockがダメらしいのですが、確かに設定にそのオプションが入っていたので、コメントアウトしてみたらあっさりいけました。
確かに、セットアップ手順を書いているブログ記事などを見ていたらそのオプションが入ってないやつがあることは気がついていたのですが、さすがに自分の目の前で動いている設定だったのでそれを踏襲してました。